<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Forum Pembahasan Orang BarBar ‚Äî Diskusi Terbuka</title>
  
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  
  <script>
    (function() {
      // Tema tetap pakai localStorage, ini sudah benar
      const savedTheme = localStorage.getItem('obrolin_theme');
      if (savedTheme === 'dark') {
        document.documentElement.classList.add('dark-mode');
      }
    })();
  </script>

  <style>
    /* --- Semua CSS lamamu tetap di sini --- */
    :root {
      --bg: #ffffff;
      --card: #f9fafb;  
      --text: #0f1724;
      --muted: #6b7280;
      --border: #e5e7eb;  
      --hover-bg: rgba(243, 244, 246, 0.9);
      --reply-bg: #f3f4f6;  
      --reply-border: #d1d5db;  
      --accent: #2563eb;
      --success: #10b981;
      --radius: 12px;
      --shadow: 0 4px 12px rgba(16, 24, 40, 0.08);  
      
      font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
    }
    html.dark-mode {
      --bg: #121212;  
      --card: #1f2937;
      --text: #f3f4f6;
      --muted: #9ca3af;
      --border: #374151;  
      --hover-bg: rgba(243, 244, 246, 0.08);  
      --reply-bg: #374151;
      --reply-border: #4b5563;
      --accent: #60a5fa;  
      --shadow: 0 6px 20px rgba(0, 0, 0, 0.7);  
    }
    * { box-sizing: border-box }
    html, body {  
      height: 100%;  
      margin: 0;  
      background: var(--bg);
      color: var(--text);  
      transition: background 0.3s, color 0.3s;
    }
    html.dark-mode ::-webkit-scrollbar { width: 8px; }
    html.dark-mode ::-webkit-scrollbar-track { background: var(--bg); }
    html.dark-mode ::-webkit-scrollbar-thumb {
      background-color: var(--reply-border);
      border-radius: 20px;
      border: 2px solid var(--bg);
    }
    .app { max-width: 980px; margin: 28px auto; padding: 18px }
    header { display: flex; gap: 12px; align-items: center; justify-content: space-between }
    .brand { display: flex; gap: 12px; align-items: center }
    .logo {  
      width: 44px; height: 44px; border-radius: 10px;  
      background: linear-gradient(135deg, var(--accent), #06b6d4);  
      display: flex; align-items: center; justify-content: center;  
      color: white; font-weight: 700;
    }
    h1 { font-size: 18px; margin: 0 }
    p.lead { margin: 0; color: var(--muted); font-size: 13px }
    .controls { display: flex; gap: 8px; align-items: center }
    button, .btn {
      background: var(--accent); color: white; border: none;  
      padding: 10px 12px; border-radius: 10px; cursor: pointer;  
      box-shadow: var(--shadow); transition: background 0.2s, box-shadow 0.2s;
    }
    button:hover, .btn:hover { opacity: 0.9; }
    .btn.secondary {  
      background: transparent; color: var(--accent);  
      border: 1px solid var(--border); box-shadow: none;  
      transition: background 0.2s, color 0.2s, border-color 0.2s;
    }
    .btn.secondary:hover { background: rgba(37, 99, 235, 0.05); }
    html.dark-mode .btn.secondary:hover { background: rgba(255, 255, 255, 0.08); }
    .icon-btn {  
      background: transparent; border: none; padding: 8px;  
      border-radius: 8px; cursor: pointer; color: var(--text);
      font-size: 18px; line-height: 1;
    }
    .icon-btn:hover { background: var(--hover-bg); }
    .grid { display: grid; grid-template-columns: 260px 1fr; gap: 18px; margin-top: 18px }
    .card {  
      background: var(--card); border-radius: var(--radius);  
      padding: 14px; box-shadow: var(--shadow); transition: background 0.3s, box-shadow 0.3s;
    }
    .categories { display: flex; flex-direction: column; gap: 8px }
    .cat {  
      padding: 8px 10px; border-radius: 10px; cursor: pointer;  
      color: var(--muted); display: flex; justify-content: space-between;  
      transition: background 0.2s, color 0.2s;
    }
    .cat:hover { background: var(--hover-bg); color: var(--text); }
    .cat.active {  
      background: rgba(37, 99, 235, 0.08); color: var(--accent); font-weight: 600;
    }
    html.dark-mode .cat.active { background: rgba(96, 165, 250, 0.2); }
    .thread { display: flex; gap: 12px; padding: 10px; border-radius: 10px; align-items: flex-start }
    .thread:hover { background: var(--hover-bg); }
    .meta { font-size: 12px; color: var(--muted) }
    .dot { width: 10px; height: 10px; border-radius: 50%; background: var(--border) }
    textarea, input[type="text"], input[type="password"], select, input[type="file"] {
      width: 100%; padding: 10px; border-radius: 10px;  
      border: 1px solid var(--border); resize: vertical;
      background: var(--card); color: var(--text);
      transition: border-color 0.3s, background 0.3s;
      box-sizing: border-box;
    }
    input[type="text"], input[type="password"] { padding: 8px; border-radius: 8px; }
    .thread-title { font-size: 18px; margin: 0 }
    .thread-actions { display: flex; gap: 8px; align-items: center }
    .reply {  
      margin-top: 12px; padding: 10px; border-radius: 10px;  
      border: 1px solid var(--reply-border); background: var(--reply-bg);
    }
    .reply .meta { font-size: 12px }
    .btn.small { padding: 6px 8px; font-size: 12px; border-radius: 6px; }
    .vote { display: flex; flex-direction: column; align-items: center; gap: 6px; padding: 6px 8px; border-radius: 8px }
    .vote button { background: transparent; border: none; cursor: pointer; color: var(--muted); }
    .vote button:hover { color: var(--accent); }
    .votes-count { font-weight: 700; color: var(--text); }
    .avatar {  
      width: 36px; height: 36px; border-radius: 10px;  
      background: var(--border); display: flex; align-items: center;  
      justify-content: center; color: var(--muted); font-weight: 700;
      user-select: none;
    }
    .avatar-img {
      width: 36px; height: 36px; border-radius: 10px;
      object-fit: cover;
      background: var(--border);
    }
    .notif-badge {  
      background: #ef4444; color: white; border-radius: 10px;  
      padding: 4px 6px; font-size: 12px;
    }
    .modal-backdrop {  
      position: fixed; inset: 0;  
      background: rgba(2, 6, 23, 0.45);  
      display: flex; align-items: center; justify-content: center;  
      padding: 16px; z-index: 999;
      animation: fadeIn 0.2s ease-out;
    }
    .modal-backdrop.nested {
        z-index: 1000;
        background: rgba(2, 6, 23, 0.2);
    }
    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }
    html.dark-mode .modal-backdrop { background: rgba(0, 0, 0, 0.8); }
    html.dark-mode .modal-backdrop.nested { background: rgba(0, 0, 0, 0.5); }
    
    .thread-media img, .thread-media video {
        max-width: 100%;
        height: auto;
        border-radius: 8px;
        margin-top: 10px;
        display: block;
        max-height: 400px;
        background: var(--border);  
        border: 1px solid var(--border);
    }
    html.dark-mode .thread-media video {
        color: var(--text);  
        background-color: var(--bg);
    }
    
    .profile-modal-content {
        font-family: Arial, "Helvetica Neue", Helvetica, sans-serif;
    }
    
    /* --- CSS BARU UNTUK MODAL AUTH --- */
    .auth-modal {
        max-width: 400px;
        padding: 24px;
        text-align: center;
    }
    .auth-modal h2 {
        margin-top: 0;
    }
    .auth-modal input {
        margin-bottom: 12px;
    }
    .auth-modal .btn-group {
        display: flex;
        gap: 10px;
        justify-content: center;
    }
    .auth-error {
        color: #ef4444;
        font-size: 14px;
        margin-top: 10px;
    }
    /* --------------------------------- */

    @media (max-width: 800px) {
      .grid { grid-template-columns: 1fr; }
      .brand h1 { font-size: 16px }
      .logo { width: 40px; height: 40px }
    }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <div class="brand">
        <div class="logo">FB</div>
        <div>
          <h1>Forum Pembahasan Orang BarBar</h1>
          <p class="lead">Diskusi Terbuka Siapa Saja</p>
        </div>
      </div>
      <div class="controls">
        <button class="icon-btn" id="my-profile-btn" title="Profil Saya">üë§</button>
        <button class="icon-btn" id="theme-toggle" title="Ganti Tema">
          <span id="theme-icon">‚òÄÔ∏è</span>
        </button>
        <button class="btn" id="new-thread-btn">Buat Thread</button>
      </div>
    </header>

    <div class="grid">
      <aside class="card">
        <h3 style="margin-top: 0">Kategori</h3>
        <div class="categories" id="categories"></div>
        <hr style="margin: 12px 0; border-color: var(--border);">
        <div>
          <strong>Info</strong>
          <p style="color: var(--muted); font-size: 13px">Versi 2.0: Terhubung dengan Supabase. Selamat datang di web sungguhan!</p>
        </div>
      </aside>

      <main>
        <div class="card" id="composer-card">
          <div style="display: flex; gap: 10px; align-items: flex-start">
            <div style="flex: 1">
              <label for="composer-name">Nama Anda (dari profil):</label>
              <input type="text" id="composer-name" placeholder="Login untuk posting..." readonly style="background: var(--reply-bg); margin-top: 4px;" />
              
              <div style="height: 12px"></div>
              
              <input type="text" id="thread-title" placeholder="Judul thread..." />
              <div style="height: 8px"></div>
              <textarea id="thread-body" placeholder="Tulis sesuatu untuk memulai diskusi..."></textarea>
              <div style="height: 8px"></div>
              <input type="text" id="thread-media-url" placeholder="URL Foto/Video/GIF (Opsional)" />
              
              <div style="display: flex; gap: 8px; justify-content: space-between; margin-top: 8px; align-items: center">
                <select id="thread-category"></select>
                <div style="display: flex; gap: 8px">
                  <button class="btn" id="post-thread">Posting</button>
                  <button class="btn secondary" id="clear-thread">Bersihkan</button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div style="height: 14px"></div>

        <div id="threads-list"></div>
      </main>
    </div>

    <div id="modal-root"></div>
    
    <div id="auth-modal-root"></div>
  </div>

  <script>
    // Variabel global
    const htmlEl = document.documentElement;
    const modalRoot = document.getElementById('modal-root');
    const authModalRoot = document.getElementById('auth-modal-root');
    
    let currentProfile = null; // Menyimpan data profil user yg login
    
    // --- KATEGORI DEFAULT ---
    const DEFAULT_CATS = [
      'Teknologi', 'Hiburan', 'Umum',  
      'Matematika', 'Biologi', 'Ekonomi', 'Fisika',  
      'Bahasa Inggris', 'Kimia', 'PP', 'Sejarah'
    ];

    // --- INISIALISASI SUPABASE ---
    const SUPABASE_URL = 'GANTI_DENGAN_URL_PROYEK_KAMU';
    const SUPABASE_ANON_KEY = 'GANTI_DENGAN_KUNCI_ANON_KAMU';

    const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // --- HELPER ---
    function el(html) { const div = document.createElement('div'); div.innerHTML = html.trim(); return div.firstChild; }
    function escapeHtml(s) { if (!s) return ''; return s.replaceAll('&', '&amp;').replaceAll('<', '&lt;').replaceAll('>', '&gt;').replaceAll('"', '&quot;').replaceAll("'", '&#039;'); }
    function truncate(s, n) { return s.length > n ? s.slice(0, n - 1) + '‚Ä¶' : s; }

    // ===== UI helpers: Modal =====
    function showModal(inner, isNested = false) {
      const backdrop = el(`<div class="modal-backdrop ${isNested ? 'nested' : ''}">${inner}</div>`);
      if (isNested) {
          modalRoot.appendChild(backdrop);
          backdrop.onclick = (e) => { if (e.target === backdrop) backdrop.remove(); };
          backdrop.querySelector('.card').onclick = (e) => e.stopPropagation();
      } else {
          modalRoot.innerHTML = '';
          modalRoot.appendChild(backdrop);
      }
    }
    function closeModal() { 
        if (modalRoot.children.length > 1) modalRoot.removeChild(modalRoot.lastChild);
        else modalRoot.innerHTML = '';
    }
    function closeAllModals() {
        modalRoot.innerHTML = '';
    }

    // ===== UI helpers: Tema (Tidak Berubah) =====
    const themeToggleBtn = document.getElementById('theme-toggle');
    const themeIcon = document.getElementById('theme-icon');
    let isDarkMode = htmlEl.classList.contains('dark-mode');  
    function applyTheme() {
      if (isDarkMode) {
        htmlEl.classList.add('dark-mode');
        themeIcon.textContent = 'üåô';
        localStorage.setItem('obrolin_theme', 'dark');
      } else {
        htmlEl.classList.remove('dark-mode');
        themeIcon.textContent = '‚òÄÔ∏è';
        localStorage.setItem('obrolin_theme', 'light');
      }
    }
    themeIcon.textContent = isDarkMode ? 'üåô' : '‚òÄÔ∏è';
    themeToggleBtn.onclick = () => { isDarkMode = !isDarkMode; applyTheme(); };

    // ===== LOGIKA PROFIL & AVATAR (BARU) =====
    
    /**
     * Mendapatkan URL publik untuk file di Supabase Storage
     * @param {string} path - Path ke file di bucket
     * @returns {string} URL publik
     */
    function getPublicUrl(path) {
        if (!path) return '';
        const { data } = supabase.storage.from('avatars').getPublicUrl(path);
        return data.publicUrl;
    }
    
    /**
     * Render Avatar
     * @param {object} profile - Objek profil ({ name, pfp_url })
     * @param {number} size - Ukuran avatar
     */
    function renderAvatar(profile, size = 36) {
        const style = `width:${size}px; height:${size}px; font-size:${size * 0.5}px;`;
        const name = profile?.name || 'A';
        const pfp = profile?.pfp_url ? getPublicUrl(profile.pfp_url) : '';
        
        if (pfp) {
            return `<img src="${pfp}" alt="${escapeHtml(name)}" class="avatar-img" style="${style}">`;
        }
        const initial = escapeHtml(name[0] || '?').toUpperCase();
        return `<div class="avatar" style="${style}">${initial}</div>`;
    }

    /**
     * Buka Modal Lihat Profil (Sekarang ASYNC)
     * @param {string} profileId - UUID dari profil
     */
    async function openProfileViewer(profileId) {
        // 1. Ambil data profil dari Supabase
        const { data: profile, error } = await supabase
            .from('profiles')
            .select('name, bio, pfp_url')
            .eq('id', profileId)
            .single();
            
        if (error) { alert('Gagal memuat profil: ' + error.message); return; }

        const modalHtml = `
        <div class="card profile-modal-content" style="max-width:500px; padding:20px; text-align:center;">
            ${renderAvatar(profile, 120)}
            <h2 style="margin-top: 10px; margin-bottom: 5px;">${escapeHtml(profile.name)}</h2>
            <div style="color: var(--muted); white-space: pre-wrap; min-height: 40px; margin-bottom: 20px;">
                ${profile.bio ? escapeHtml(profile.bio) : '<i>Pengguna ini belum menulis bio.</i>'}
            </div>
            <button class="btn secondary" id="close-profile-viewer">Tutup</button>
        </div>
        `;
        showModal(modalHtml, true); 
        document.getElementById('close-profile-viewer').onclick = closeModal;
    }

    /**
     * Buka Modal Edit Profil (Hanya untuk user yg login)
     */
    async function openProfileEditor() {
        if (!currentProfile) { showLoginModal(); return; }
        
        const user = currentProfile; // Ambil dari data global
        let newPfpFile = null; // Untuk menyimpan file yg akan di-upload

        const modalHtml = `
        <div class="card profile-modal-content" style="max-width:500px; padding:20px;">
            <h2>Edit Profil</h2>
            
            <label for="profile-name-input" style="font-weight: 600;">Nama Tampilan Anda:</label>
            <input type="text" id="profile-name-input" placeholder="Nama Anda..." value="${escapeHtml(user.name)}" style="margin-top: 4px;">
            <div style="height:16px"></div>

            <label style="font-weight: 600;">Foto Profil:</label>
            <div style="text-align:center; margin-bottom: 12px; margin-top: 8px;">
                <div id="pfp-preview-container">
                    ${renderAvatar(user, 100)}
                </div>
            </div>
            
            <label for="pfp-upload">Ganti foto (max 2MB):</label>
            <input type="file" id="pfp-upload" accept="image/png, image/jpeg, image/gif, image/webp" style="padding: 5px; margin-top: 4px;">
            
            <div style="height:16px"></div>
            
            <label for="bio-input" style="font-weight: 600;">Bio:</label>
            <textarea id="bio-input" placeholder="Ceritakan sedikit tentang diri Anda..." style="min-height: 80px; margin-top: 4px;">${escapeHtml(user.bio || '')}</textarea>
            
            <div style="display:flex; justify-content: space-between; gap: 8px; margin-top: 16px;">
                <button class="btn secondary" id="auth-logout" style="background: #ef4444; color: white; border: none;">Logout</button>
                <div>
                    <button class="btn secondary" id="cancel-profile">Batal</button>
                    <button class="btn" id="save-profile">Simpan</button>
                </div>
            </div>
        </div>
        `;
        
        closeAllModals();
        showModal(modalHtml, false);
        
        const pfpPreviewContainer = document.getElementById('pfp-preview-container');

        // Handle File Upload (Preview)
        document.getElementById('pfp-upload').onchange = (e) => {
            const file = e.target.files[0];
            if (!file) return;
            if (file.size > 2 * 1024 * 1024) { alert('Ukuran file terlalu besar. Maksimal 2MB.'); return; }
            
            newPfpFile = file; // Simpan file untuk di-upload
            
            // Buat preview lokal
            const reader = new FileReader();
            reader.onload = (event) => {
                pfpPreviewContainer.innerHTML = `<img src="${event.target.result}" alt="Preview" class="avatar-img" style="width:100px; height:100px;">`;
            };
            reader.readAsDataURL(file);
        };
        
        // Handle Logout
        document.getElementById('auth-logout').onclick = async () => {
            await supabase.auth.signOut();
            closeAllModals();
        };

        // Handle Tombol Simpan
        document.getElementById('save-profile').onclick = async () => {
            const saveBtn = document.getElementById('save-profile');
            saveBtn.disabled = true;
            saveBtn.textContent = 'Menyimpan...';

            const newName = document.getElementById('profile-name-input').value.trim();
            const newBio = document.getElementById('bio-input').value.trim();

            if (!newName) { alert('Nama tidak boleh kosong.'); return; }

            try {
                let pfp_path = user.pfp_url; // Path lama (jika ada)

                // 1. Jika ada file baru, upload dulu
                if (newPfpFile) {
                    const fileExt = newPfpFile.name.split('.').pop();
                    const fileName = `${user.id}-${Date.now()}.${fileExt}`;
                    const filePath = `${fileName}`;
                    
                    const { error: uploadError } = await supabase.storage
                        .from('avatars')
                        .upload(filePath, newPfpFile);
                    
                    if (uploadError) throw uploadError;
                    pfp_path = filePath; // Simpan path baru
                }
                
                // 2. Update data di tabel 'profiles'
                const { data: updatedProfile, error: updateError } = await supabase
                    .from('profiles')
                    .update({
                        name: newName,
                        bio: newBio,
                        pfp_url: pfp_path
                    })
                    .eq('id', user.id)
                    .select()
                    .single(); // Ambil data baru

                if (updateError) throw updateError;
                
                // 3. Update data 'currentProfile' global
                currentProfile = updatedProfile;
                
                alert('Profil berhasil diperbarui!');
                closeAllModals();
                renderComposer(); // Update nama di composer
                renderThreads(); // Render ulang semua thread untuk update avatar/nama
                
            } catch (error) {
                alert('Gagal menyimpan profil: ' + error.message);
                saveBtn.disabled = false;
                saveBtn.textContent = 'Simpan';
            }
        };
        
        document.getElementById('cancel-profile').onclick = closeAllModals;
    }
    
    // ===== LOGIKA KATEGORI (Tidak Berubah) =====
    function renderCategories(active = 'Semua') {
      const root = document.getElementById('categories'); root.innerHTML = '';
      const cats = ['Semua', ...DEFAULT_CATS];
      cats.forEach(c => {
        const d = el(`<div class="cat ${c === active ? 'active' : ''}" data-cat="${c}">${c} <span style="color:var(--muted)"></span></div>`);
        d.onclick = async () => { 
            renderCategories(c); 
            await renderThreads(c); // Jadikan async
            document.getElementById('thread-category').value = (DEFAULT_CATS.includes(c) ? c : DEFAULT_CATS[0]); 
        }
        root.appendChild(d);
      })
    }
    
    // ===== LOGIKA COMPOSER (BARU) =====
    function renderComposer() {
      // Isi pilihan kategori
      const sel = document.getElementById('thread-category'); 
      sel.innerHTML = ''; 
      DEFAULT_CATS.forEach(c => { 
          const opt = document.createElement('option'); 
          opt.value = c; opt.textContent = c; sel.appendChild(opt); 
      });
      
      document.getElementById('post-thread').onclick = postThread;
      document.getElementById('clear-thread').onclick = () => {  
        document.getElementById('thread-title').value = '';  
        document.getElementById('thread-body').value = '';  
        document.getElementById('thread-media-url').value = '';  
      }

      // Isi nama dari profil
      const composerNameInput = document.getElementById('composer-name');
      if (currentProfile) {
          composerNameInput.value = currentProfile.name;
      } else {
          composerNameInput.value = '';
          composerNameInput.placeholder = 'Login untuk posting...';
      }
    }
    
    /**
     * Posting Thread Baru (ASYNC)
     */
    async function postThread() {
      if (!currentProfile) {
          alert('Anda harus login untuk posting.');
          showLoginModal();
          return;
      }
      
      const title = document.getElementById('thread-title').value.trim();
      const body = document.getElementById('thread-body').value.trim();
      const category = document.getElementById('thread-category').value;
      const mediaUrl = document.getElementById('thread-media-url').value.trim();  
      
      if (!title || !body) { alert('Judul dan isi thread wajib diisi.'); return; }
      
      const newThread = {  
        title,  
        body,  
        category,  
        media_url: mediaUrl || null,  
        author_id: currentProfile.id
      };
      
      // Kirim ke Supabase
      const { error } = await supabase.from('threads').insert(newThread);
      
      if (error) {
          alert('Gagal posting: ' + error.message);
      } else {
          renderThreads(); // Muat ulang daftar thread
          document.getElementById('thread-title').value = '';  
          document.getElementById('thread-body').value = '';
          document.getElementById('thread-media-url').value = '';  
      }
    }
    
    // HELPER: Media (Tidak Berubah)
    function createMediaElement(url) {
        if (!url) return '';
        const ext = url.split('.').pop().toLowerCase().split('?')[0];  
        let mediaHtml = '';
        if (['jpg', 'jpeg', 'png', 'gif', 'webp'].includes(ext)) {
            mediaHtml = `<img src="${url}" alt="Thread Media" loading="lazy">`;
        } else if (['mp4', 'webm', 'ogg'].includes(ext)) {
            mediaHtml = `<video src="${url}" controls loading="lazy"></video>`;
        }
        if (mediaHtml) return `<div class="thread-media">${mediaHtml}</div>`;
        return '';
    }

    // ===== LOGIKA THREADS (BARU) =====

    /**
     * Render Daftar Thread (ASYNC)
     * @param {string} filter - Filter kategori
     */
    async function renderThreads(filter = 'Semua') {
      const list = document.getElementById('threads-list'); 
      list.innerHTML = '<div class="card" style="text-align:center; padding: 20px;">Memuat threads...</div>';
      
      // 1. Buat query
      let query = supabase
          .from('threads')
          // Ini adalah "JOIN" di Supabase: ambil semua kolom thread (*),
          // dan dari tabel 'profiles' yang terhubung, ambil kolom 'name' dan 'pfp_url'
          .select(`
              *,
              profiles ( name, pfp_url )
          `)
          .order('created_at', { ascending: false }); // Urutkan terbaru di atas
          
      // 2. Tambahkan filter jika ada
      if (filter !== 'Semua') {
          query = query.eq('category', filter);
      }
      
      const { data: threads, error } = await query;
      
      if (error) {
          list.innerHTML = `<div class="card" style="text-align:center; padding: 20px; color: #ef4444;">Gagal memuat: ${error.message}</div>`;
          return;
      }
      
      if (threads.length === 0) {
          list.innerHTML = '<div class="card" style="text-align:center; padding: 20px;">Belum ada thread. Jadilah yang pertama!</div>';
          return;
      }
      
      list.innerHTML = ''; // Kosongkan list
      
      threads.forEach(t => {
        // 't.profiles' akan berisi objek {name, pfp_url} berkat "JOIN"
        const user = t.profiles; 
        const mediaPreview = createMediaElement(t.media_url);  
        const avatarHtml = renderAvatar(user, 36);
        
        // Hitung jumlah balasan (akan kita implementasi nanti)
        // Untuk sekarang, kita tidak tahu jumlah balasan.
        // TODO: Buat 'reply_count'
        
        const item = el(`
          <div class="card thread" style="padding:15px">
            <div style="display:flex; flex-direction: column; gap:12px; align-items:center; width: 40px;">
                <div class="avatar-wrapper" data-id="${t.author_id}" style="cursor:pointer;" title="Lihat profil ${escapeHtml(user.name)}">
                    ${avatarHtml}
                </div>
                <div class="vote">
                    <button class="up" data-id="${t.id}" data-votes="${t.votes}">‚ñ≤</button>
                    <div class="votes-count">${t.votes}</div>
                    <button class="down" data-id="${t.id}" data-votes="${t.votes}">‚ñº</button>
                </div>
            </div>
            <div style="flex:1">
              <div style="display:flex;justify-content:space-between;align-items:start">
                <div>
                  <div style="font-weight:700">${escapeHtml(t.title)}</div>
                  <div class="meta">oleh 
                    <strong class="author-name" data-id="${t.author_id}" style="cursor:pointer; color: var(--text);" title="Lihat profil ${escapeHtml(user.name)}">${escapeHtml(user.name)}</strong> 
                    ‚Ä¢ ${new Date(t.created_at).toLocaleString()}
                  </div>
                </div>
                <div class="meta">${escapeHtml(t.category)}</div>
              </div>
              <div style="margin-top:8px;color:var(--muted);">${escapeHtml(truncate(t.body, 200))}</div>
              ${mediaPreview}  
              <div style="margin-top:10px;display:flex;gap:8px">
                <button class="btn small" data-id="${t.id}" data-action="open">Buka</button>
                <button class="btn secondary small" data-id="${t.id}" data-action="share">Bagikan</button>
              </div>
            </div>
          </div>
        `);
        list.appendChild(item);
        
        // Event listeners
        item.querySelector('.avatar-wrapper').onclick = () => openProfileViewer(t.author_id);
        item.querySelector('.author-name').onclick = () => openProfileViewer(t.author_id);
        item.querySelector('[data-action=open]').onclick = () => openThread(t.id);
        item.querySelector('[data-action=share]').onclick = () => { navigator.clipboard?.writeText(window.location.href + '#t=' + t.id).then(() => alert('Link disalin ke clipboard')) }
        
        // Vote listeners
        item.querySelector('.up').onclick = (e) => handleVote('threads', t.id, t.votes, 1, e.target);
        item.querySelector('.down').onclick = (e) => handleVote('threads', t.id, t.votes, -1, e.target);
      });
    }

    /**
     * Buka Detail Thread (ASYNC)
     * @param {number} id - ID thread
     */
    async function openThread(id) {
      // 1. Ambil data thread tunggal, "JOIN" dengan profil author
      const { data: t, error } = await supabase
          .from('threads')
          .select(`*, profiles ( id, name, pfp_url )`)
          .eq('id', id)
          .single(); // Ambil satu
          
      if (error) { alert('Gagal memuat thread: ' + error.message); return; }
      
      const user = t.profiles;
      const mediaElementFull = createMediaElement(t.media_url);  
      const avatarHtml = renderAvatar(user, 40);
      
      let html = `<div class="card" style="max-width:820px; padding:20px; max-height: 90vh; overflow-y: auto;">
        <div style="display:flex;gap:12px;align-items:flex-start">
          <div style="display:flex; flex-direction:column; align-items:center; gap: 8px; width: 40px;">
              <div class="avatar-wrapper" data-id="${user.id}" style="cursor:pointer;" title="Lihat profil ${escapeHtml(user.name)}">
                  ${avatarHtml}
              </div>
              <div class="vote" style="padding:0;">
                <button class="icon-btn up" data-id="${t.id}" data-votes="${t.votes}">‚ñ≤</button>
                <div style="font-size:24px; color:var(--accent);">${t.votes}</div>
                <button class="icon-btn down" data-id="${t.id}" data-votes="${t.votes}">‚ñº</button>
              </div>
          </div>
          <div style="flex:1">
            <h2 class="thread-title">${escapeHtml(t.title)}</h2>
            <div class="meta">oleh 
                <strong class="author-name" data-id="${user.id}" style="cursor:pointer; color: var(--text);" title="Lihat profil ${escapeHtml(user.name)}">${escapeHtml(user.name)}</strong> 
                ‚Ä¢ ${new Date(t.created_at).toLocaleString()} ‚Ä¢ ${escapeHtml(t.category)}
            </div>
            <div style="height:12px"></div>
            <div style="white-space:pre-wrap; margin-bottom:15px;">${escapeHtml(t.body)}</div>
            ${mediaElementFull}  
            <div class="thread-actions">
              <button class="btn secondary" id="close-thread">Tutup</button>
            </div>
          </div>
        </div>
        <hr style="margin:16px 0; border-color: var(--border);">
        <h3 style="margin-top:0">Balasan</h3>
        <div id="replies-root">Memuat balasan...</div>
        <div style="height:10px"></div>
        <div class="card" style="padding:10px 14px; border:1px solid var(--border); box-shadow:none;">
          <div style="display:flex;gap:10px">
            <div style="flex:1">
              <input type="text" id="reply-name" value="${currentProfile?.name || ''}" placeholder="Login untuk membalas..." readonly style="padding: 8px; border-radius: 8px; margin-bottom: 8px; background: var(--reply-bg);" />
              <textarea id="reply-body" placeholder="Tulis balasan..."></textarea>
              <div style="display:flex;justify-content:flex-end;margin-top:8px">
                <button class="btn" id="post-reply">Kirim Balasan</button>
              </div>
            </div>
          </div>
        </div>
      </div>`;
      showModal(html);

      // Listener di dalam modal
      document.querySelector('.modal-backdrop .avatar-wrapper').onclick = (e) => openProfileViewer(e.currentTarget.dataset.id);
      document.querySelector('.modal-backdrop .author-name').onclick = (e) => openProfileViewer(e.currentTarget.dataset.id);
      document.getElementById('close-thread').onclick = closeAllModals;
      
      // Vote listener
      document.querySelector('.modal-backdrop .up').onclick = (e) => handleVote('threads', t.id, t.votes, 1, e.target);
      document.querySelector('.modal-backdrop .down').onclick = (e) => handleVote('threads', t.id, t.votes, -1, e.target);
      
      // Kirim Balasan
      document.getElementById('post-reply').onclick = async () => {
        if (!currentProfile) { alert('Login untuk membalas.'); showLoginModal(); return; }
        
        const body = document.getElementById('reply-body').value.trim();
        if (!body) { alert('Isi balasan wajib diisi.'); return; }
        
        const newReply = {
            body,
            author_id: currentProfile.id,
            thread_id: t.id,
            parent_id: null // Ini balasan level atas
        };
        
        const { error } = await supabase.from('replies').insert(newReply);
        if (error) {
            alert('Gagal mengirim balasan: ' + error.message);
        } else {
            document.getElementById('reply-body').value = '';
            await renderReplies(t.id); // Muat ulang daftar balasan
        }
      };
      
      // Terakhir, muat balasannya
      await renderReplies(t.id);
    }
    
    /**
     * Render Daftar Balasan (ASYNC & REKURSIF)
     * @param {number} threadId - ID thread
     */
    async function renderReplies(threadId) {
      const root = document.getElementById('replies-root');
      root.innerHTML = 'Memuat...';

      // 1. Ambil SEMUA balasan untuk thread ini, "JOIN" dgn profil
      const { data: replies, error } = await supabase
          .from('replies')
          .select(`*, profiles ( id, name, pfp_url )`)
          .eq('thread_id', threadId)
          .order('created_at', { ascending: true }); // Urutkan dari terlama
          
      if (error) { root.innerHTML = `<div style="color: #ef4444;">Gagal memuat balasan: ${error.message}</div>`; return; }
      if (replies.length === 0) { root.innerHTML = '<i>Belum ada balasan.</i>'; return; }
      
      // 2. Susun data jadi struktur pohon (nested)
      const replyMap = {};
      const nestedReplies = [];
      
      replies.forEach(r => {
          replyMap[r.id] = { ...r, children: [] };
      });
      
      replies.forEach(r => {
          if (r.parent_id && replyMap[r.parent_id]) {
              replyMap[r.parent_id].children.push(replyMap[r.id]);
          } else {
              nestedReplies.push(replyMap[r.id]);
          }
      });

      // 3. Fungsi rekursif untuk render HTML
      function renderList(list, container, depth) {
        list.forEach(r => {
          const user = r.profiles;
          const avatarHtml = renderAvatar(user, 28);

          const rep = document.createElement('div'); 
          rep.className = 'reply'; 
          rep.style.marginLeft = (depth * 20) + 'px'; // Ubah margin
          
          rep.innerHTML = `
          <div style="display:flex; gap: 8px; align-items:flex-start;">
              <div class="avatar-wrapper" data-id="${user.id}" style="cursor:pointer; margin-top: 2px;" title="Lihat profil ${escapeHtml(user.name)}">
                  ${avatarHtml}
              </div>
              <div style="flex:1;">
                  <div style="display:flex;justify-content:space-between">
                      <div>
                          <strong class="author-name" data-id="${user.id}" style="cursor:pointer; color: var(--text);" title="Lihat profil ${escapeHtml(user.name)}">${escapeHtml(user.name)}</strong>
                          <div class="meta">${new Date(r.created_at).toLocaleString()}</div>
                      </div>
                      <div class="meta">Votes: <span class="votes-count-reply">${r.votes}</span></div>
                  </div>
                  <div style="margin-top:8px;white-space:pre-wrap">${escapeHtml(r.body)}</div>
                  <div style="margin-top:8px;display:flex;gap:8px">
                      <button class="btn small" data-id="${r.id}" data-action="reply">Balas</button>
                      <button class="icon-btn" data-id="${r.id}" data-action="up" data-votes="${r.votes}" style="padding: 4px;">‚ñ≤</button>
                      <button class="icon-btn" data-id="${r.id}" data-action="down" data-votes="${r.votes}" style="padding: 4px;">‚ñº</button>
                  </div>
              </div>
          </div>`;
          container.appendChild(rep);

          // Listeners
          rep.querySelector('.avatar-wrapper').onclick = (e) => openProfileViewer(e.currentTarget.dataset.id);
          rep.querySelector('.author-name').onclick = (e) => openProfileViewer(e.currentTarget.dataset.id);
          
          // Vote listeners
          rep.querySelector('[data-action=up]').onclick = (e) => handleVote('replies', r.id, r.votes, 1, e.target);
          rep.querySelector('[data-action=down]').onclick = (e) => handleVote('replies', r.id, r.votes, -1, e.target);

          // Tombol Balas (untuk nested)
          rep.querySelector('[data-action=reply]').onclick = (e) => {
              const btn = e.target;
              const existingBox = rep.querySelector('.reply-box');
              if (existingBox) { existingBox.remove(); btn.textContent = 'Balas'; return; }
              
              btn.textContent = 'Batal';
              const box = document.createElement('div'); 
              box.className = 'reply-box'; 
              box.style.marginTop = '8px';
              box.innerHTML = `
                <input type="text" value="${currentProfile?.name || ''}" readonly style="width:100%; padding: 8px; border-radius: 8px; border: 1px solid var(--border); background: var(--card); color: var(--muted); margin-bottom: 6px; box-sizing: border-box;" />
                <textarea placeholder="Balas..." style="width:100%;min-height:60px; padding:8px;"></textarea>
                <div style="display:flex;justify-content:flex-end;margin-top:6px"><button class="btn small">Kirim</button></div>`;
              rep.appendChild(box);

              box.querySelector('button').onclick = async () => {
                if (!currentProfile) { alert('Login untuk membalas.'); showLoginModal(); return; }
                const txt = box.querySelector('textarea').value.trim();  
                if (!txt) { alert('Balasan wajib diisi.'); return; }
                
                const newNestedReply = {
                    body: txt,
                    author_id: currentProfile.id,
                    thread_id: threadId,
                    parent_id: r.id // Nah, ini kuncinya
                };
                
                const { error }_ = await supabase.from('replies').insert(newNestedReply);
                if (error) {
                    alert('Gagal mengirim balasan: ' + error.message);
                } else {
                    await renderReplies(threadId); // Muat ulang semua balasan
                }
              }
          }
          
          // REKURSI: Render anak-anaknya
          if (r.children && r.children.length > 0) {
              renderList(r.children, container, depth + 1);
          }
        })
      }
      
      root.innerHTML = '';
      renderList(nestedReplies, root, 0); // Mulai render dari level atas
    }
    
    /**
     * Handle Vote (ASYNC)
     * @param {string} table - 'threads' or 'replies'
     * @param {number} id - ID item
     * @param {number} currentVotes - Vote saat ini
     * @param {number} direction - 1 (up) or -1 (down)
     * @param {HTMLElement} btn - Tombol yg diklik
     */
    async function handleVote(table, id, currentVotes, direction, btn) {
        if (!currentProfile) { alert('Login untuk vote.'); showLoginModal(); return; }
        
        btn.disabled = true; // Cegah klik ganda
        const newCount = currentVotes + direction;
        
        const { error } = await supabase
            .from(table)
            .update({ votes: newCount })
            .eq('id', id);
        
        if (error) {
            alert('Gagal vote: ' + error.message);
            btn.disabled = false;
        } else {
            // Update vote di UI
            const parent = btn.parentElement;
            parent.querySelector('.votes-count').textContent = newCount;
            // Update data-votes di tombol agar vote selanjutnya benar
            parent.querySelector('.up').dataset.votes = newCount;
            parent.querySelector('.down').dataset.votes = newCount;
            btn.disabled = false;
        }
    }


    // ===== LOGIKA AUTH (BARU) =====

    /**
     * Tampilkan Modal Login/Signup
     */
    function showLoginModal() {
        closeAllModals(); // Tutup modal lain
        const modalHtml = `
        <div class="card auth-modal">
            <h2>Selamat Datang!</h2>
            <p style="color: var(--muted);">Silakan login atau daftar untuk berpartisipasi.</p>
            <input type="email" id="auth-email" placeholder="Email Anda" autocomplete="email" />
            <input type="password" id="auth-pass" placeholder="Password (min. 6 karakter)" autocomplete="current-password" />
            
            <div class="auth-error" id="auth-error-msg"></div>
            
            <div class="btn-group" style="margin-top: 16px;">
                <button class="btn" id="auth-login-btn">Login</button>
                <button class="btn secondary" id="auth-signup-btn">Daftar</button>
            </div>
        </div>
        `;
        // Tampilkan modal di root-nya sendiri
        authModalRoot.innerHTML = `<div class="modal-backdrop">${modalHtml}</div>`;
        
        const errorMsg = document.getElementById('auth-error-msg');

        // Event listener Login
        document.getElementById('auth-login-btn').onclick = async () => {
            const email = document.getElementById('auth-email').value;
            const pass = document.getElementById('auth-pass').value;
            const { error } = await supabase.auth.signInWithPassword({ email, password: pass });
            if (error) errorMsg.textContent = error.message;
        };
        
        // Event listener Signup
        document.getElementById('auth-signup-btn').onclick = async () => {
            const email = document.getElementById('auth-email').value;
            const pass = document.getElementById('auth-pass').value;
            const { error } = await supabase.auth.signUp({ email, password: pass });
            if (error) errorMsg.textContent = error.message;
            else errorMsg.textContent = 'Berhasil mendaftar! Silakan login.';
        };
    }
    
    function closeLoginModal() {
        authModalRoot.innerHTML = '';
    }
    
    /**
     * Inisialisasi Aplikasi (Fungsi Utama)
     */
    async function initApp() {
        // Cek status login
        supabase.auth.onAuthStateChange(async (event, session) => {
            if (session) {
                // USER LOGIN
                const user = session.user;
                
                // Ambil profilnya dari tabel 'profiles'
                const { data, error } = await supabase
                    .from('profiles')
                    .select('*')
                    .eq('id', user.id)
                    .single();
                    
                if (error) {
                    alert('Gagal mengambil profil: ' + error.message);
                } else {
                    currentProfile = data; // Simpan profil di global
                    closeLoginModal();
                    
                    // Update UI
                    document.getElementById('my-profile-btn').onclick = openProfileEditor;
                    renderComposer(); // Isi nama di composer
                }
                
            } else {
                // USER LOGOUT
                currentProfile = null;
                document.getElementById('my-profile-btn').onclick = showLoginModal;
                renderComposer(); // Kosongkan nama
                showLoginModal(); // Tampilkan modal login
            }
        });
        
        // Render UI utama
        renderComposer();  
        renderCategories();  
        await renderThreads();  

        // Cek deep-link (Tidak berubah)
        if (window.location.hash.startsWith('#t=')) { 
            const id = window.location.hash.split('=')[1]; 
            setTimeout(() => openThread(id), 600); 
        }
    }
    
    // ===== MULAI APLIKASI =====
    initApp();

  </script>
</body>
</html>
